{% extends "base.html" %}

{% block content %}
<div class="dashboard-section">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-content">
                    <div class="user-info text-center mb-4">
                        <div class="user-avatar mb-2">
                            <i class="fas fa-chalkboard-teacher fa-3x text-success"></i>
                        </div>
                        <h6 class="fw-bold">{{ session.user_name }}</h6>
                        <small class="text-muted">Faculty Portal</small>
                    </div>
                    
                        <nav class="nav flex-column">
                            <a class="nav-link active" href="#dashboard-overview">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                            <a class="nav-link" href="#in-progress-feedback">
                                <i class="fas fa-comment-dots me-2"></i>Feedback Sessions
                            </a>
                            <a class="nav-link" href="#grades-section">
                                <i class="fas fa-graduation-cap me-2"></i>Grades
                            </a>
                            <a class="nav-link" href="#faculty-profile">
                                <i class="fas fa-user me-2"></i>Profile
                            </a>
                        </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content" id="dashboard-overview">
                <div class="dashboard-header mb-4">
                    <h1 class="h3 fw-bold">Faculty Dashboard</h1>
                    <p class="text-muted">Manage your courses and students</p>
                </div>

                <!-- Feedback Sessions -->
                <div class="admin-section mb-4" id="in-progress-feedback">
                    <div class="section-header d-flex justify-content-between align-items-center mb-2">
                        <h4><i class="fas fa-comments text-secondary me-2"></i>My Feedback Sessions</h4>
                        <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#facultySessionModal" {% if not taught_courses %}disabled{% endif %}>
                            <i class="fas fa-plus me-1"></i>Start Session
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Session ID</th>
                                    <th>Course</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if faculty_sessions %}
                                    {% for s in faculty_sessions %}
                                    <tr>
                                        <td><strong>{{ s.session_id }}</strong></td>
                                        <td>{{ s.course_name }} ({{ s.course_id }})</td>
                                        <td>{{ s.start_date }}</td>
                                        <td>{{ s.end_date }}</td>
                                        <td><span class="badge bg-{{ 'success' if s.status == 'Active' else 'secondary' }}">{{ s.status }}</span></td>
                                        <td>
                                            <a href="{{ url_for('faculty_feedback_report', session_id=s.session_id) }}" class="btn btn-sm btn-outline-primary">View Summary</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="6" class="text-center text-muted">No feedback sessions yet. Start one using the button.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- My Courses -->
                <div class="admin-section mb-4" id="assigned-courses">
                            <div class="section-header">
                                <h4><i class="fas fa-chalkboard text-success me-2"></i>My Assigned Courses</h4>
                            </div>
                            {% if taught_courses %}
                            {% for course in taught_courses %}
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-book me-2"></i>
                                        {{ course.course_name }} ({{ course.course_code }})
                                    </h5>
                                    <small>{{ format_semester(course.semester) }}</small>
                                </div>
                                <div class="card-body">
                                    <h6>Enrolled Students:</h6>
                                    {% if course_students[course.course_id] %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Student ID</th>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Program</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for student in course_students[course.course_id] %}
                                                <tr>
                                                    <td><strong>{{ student.student_id }}</strong></td>
                                                    <td>{{ student.name }}</td>
                                                    <td>{{ student.email }}</td>
                                                    <td><span class="badge bg-info">{{ student.program }}</span></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p class="text-muted">No students enrolled yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="empty-state text-center py-5">
                                <i class="fas fa-chalkboard fa-4x text-muted mb-3"></i>
                                <h4>No Courses Assigned</h4>
                                <p class="text-muted">You haven't been assigned to any courses yet.</p>
                            </div>
                            {% endif %}
                </div>

                <!-- Grades Section -->
                <div class="admin-section mt-4" id="grades-section">
                    <div class="section-header">
                        <h4><i class="fas fa-graduation-cap text-warning me-2"></i>Student Grades</h4>
                    </div>
                    {% if taught_courses %}
                    {% for course in taught_courses %}
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-book me-2"></i>
                                {{ course.course_name }} ({{ course.course_code }})
                            </h5>
                            <small>{{ format_semester(course.semester) }}</small>
                        </div>
                        <div class="card-body">
                            <!-- Export Buttons -->
                            <div class="mb-3">
                                <a href="{{ url_for('export_grades', course_id=course.course_id, format='csv') }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-file-csv me-1"></i>Export CSV
                                </a>
                            </div>

                            {% if course_students[course.course_id] %}
                            <div class="table-responsive">
                                <!-- Grade distribution chart + Pass/Fail pie -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <canvas id="gradeBarChart-{{ course.course_id }}" height="120"></canvas>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                                        <div style="width:160px;">
                                            <canvas id="passFailChart-{{ course.course_id }}" height="160"></canvas>
                                            <div class="text-center small mt-2" id="passFailLabel-{{ course.course_id }}"></div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Student Name</th>
                                            <th>Current Grade</th>
                                            <th>Assign Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in course_students[course.course_id] %}
                                        {% set current_grade = student_grades.get((student.student_id, course.course_id)) %}
                                        <tr {% if current_grade and current_grade.grade == 'F' %}class="table-danger"{% endif %}>
                                            <td><strong>{{ student.student_id }}</strong></td>
                                            <td>
                                                {{ student.name }}
                                                {% if current_grade and current_grade.grade == 'F' %}
                                                    <span class="badge bg-danger ms-2">FAILED</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if current_grade %}
                                                    <span class="badge bg-success">{{ current_grade.grade }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">NP</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <form method="POST" action="{{ url_for('assign_grade') }}" class="d-inline">
                                                    <input type="hidden" name="student_id" value="{{ student.student_id }}">
                                                    <input type="hidden" name="course_id" value="{{ course.course_id }}">
                                                    <div class="input-group input-group-sm" style="width: 200px;">
                                                        <select class="form-select form-select-sm" name="grade" required>
                                                            <option value="">Select Grade</option>
                                                            <option value="A+" {% if current_grade and current_grade.grade == 'A+' %}selected{% endif %}>A+</option>
                                                            <option value="A" {% if current_grade and current_grade.grade == 'A' %}selected{% endif %}>A</option>
                                                            <option value="B+" {% if current_grade and current_grade.grade == 'B+' %}selected{% endif %}>B+</option>
                                                            <option value="B" {% if current_grade and current_grade.grade == 'B' %}selected{% endif %}>B</option>
                                                            <option value="C" {% if current_grade and current_grade.grade == 'C' %}selected{% endif %}>C</option>
                                                            <option value="F" {% if current_grade and current_grade.grade == 'F' %}selected{% endif %}>F</option>
                                                        </select>
                                                        <button type="submit" class="btn btn-warning btn-sm">
                                                            <i class="fas fa-save"></i>
                                                        </button>
                                                    </div>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <script>
                                (function(){
                                    const courseId = "{{ course.course_id }}";
                                    const canvasId = 'gradeBarChart-' + courseId;
                                    const ctx = document.getElementById(canvasId);
                                    if (!ctx) return;

                                    fetch(`/faculty/grade_counts/${courseId}`)
                                        .then(r => r.json())
                                        .then(data => {
                                            if (data.error) return;
                                            new Chart(ctx, {
                                                type: 'bar',
                                                data: {
                                                    labels: data.labels,
                                                    datasets: [{
                                                        label: 'Number of students',
                                                        data: data.counts,
                                                        backgroundColor: ['#2d9cdb','#1abc9c','#3498db','#9b59b6','#f1c40f','#e74c3c']
                                                    }]
                                                },
                                                options: {
                                                    plugins: { legend: { display: false } },
                                                    scales: { y: { beginAtZero: true, precision: 0 } }
                                                }
                                            });
                                        }).catch(err => {
                                            console.error('Error loading grade distribution', err);
                                        });

                                    // Load pass/fail pie
                                    const passFailCtx = document.getElementById('passFailChart-' + courseId);
                                    fetch(`/faculty/pass_fail/${courseId}`)
                                        .then(r => r.json())
                                        .then(p => {
                                            if (p.error) return;
                                            const pfData = [p.passed, p.failed];
                                            new Chart(passFailCtx, {
                                                type: 'pie',
                                                data: {
                                                    labels: ['Passed', 'Failed'],
                                                    datasets: [{ data: pfData, backgroundColor: ['#1abc9c', '#e74c3c'] }]
                                                },
                                                options: { plugins: { legend: { position: 'bottom' } } }
                                            });
                                            const labelEl = document.getElementById('passFailLabel-' + courseId);
                                            if (labelEl) labelEl.textContent = `Pass: ${p.passed_pct}% Â· Fail: ${p.failed_pct}%`;
                                        }).catch(err => console.error('Error loading pass/fail', err));
                                })();
                            </script>
                            {% else %}
                            <p class="text-muted">No students enrolled in this course.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <i class="fas fa-graduation-cap fa-4x text-muted mb-3"></i>
                        <h4>No Courses Assigned</h4>
                        <p class="text-muted">You haven't been assigned to any courses yet.</p>
                    </div>
                    {% endif %}
                </div>

                <div class="admin-section mt-4" id="faculty-profile">
                    <div class="section-header">
                        <h4><i class="fas fa-id-card text-primary me-2"></i>Your Profile</h4>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-sm-4">
                                    <p class="mb-1 text-muted">Name</p>
                                    <h6 class="mb-0">{{ faculty_info.name or session.user_name }}</h6>
                                </div>
                                <div class="col-sm-4">
                                    <p class="mb-1 text-muted">Faculty ID</p>
                                    <h6 class="mb-0">{{ faculty_info.faculty_id or session.user_id }}</h6>
                                </div>
                                <div class="col-sm-4">
                                    <p class="mb-1 text-muted">Department</p>
                                    <h6 class="mb-0">{{ faculty_info.department or "N/A" }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Start Feedback Session Modal -->
<div class="modal fade" id="facultySessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Start Feedback Session</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('faculty_create_feedback_session') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="faculty_session_id" class="form-label">Session ID</label>
                        <input type="text" class="form-control" id="faculty_session_id" name="session_id" required>
                    </div>
                    <div class="mb-3">
                        <label for="faculty_session_course" class="form-label">Course</label>
                        <select class="form-select" id="faculty_session_course" name="course_id" required>
                            <option value="">Select Course</option>
                            {% for course in taught_courses %}
                                <option value="{{ course.course_id }}">{{ course.course_name }} ({{ course.course_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="faculty_session_start" class="form-label">Start</label>
                        <input type="datetime-local" class="form-control" id="faculty_session_start" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="faculty_session_end" class="form-label">End</label>
                        <input type="datetime-local" class="form-control" id="faculty_session_end" name="end_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-secondary"><i class="fas fa-save me-1"></i>Start Session</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Simple JavaScript for any future enhancements
document.addEventListener('DOMContentLoaded', function() {
    console.log('Faculty dashboard loaded successfully');
});
</script>

{% endblock %}